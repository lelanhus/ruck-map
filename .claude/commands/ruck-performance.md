---
description: Profile and optimize RuckMap performance using performance-expert
allowed-tools: Task, Bash, Read, Write, Grep
argument-hint: "[battery|memory|cpu|ui|all] [--fix]"
---

# /ruck-performance

Profile and optimize RuckMap performance using the performance-expert sub-agent.

## Usage

```
/ruck-performance [metric] [--fix]
```

## Metrics

- `battery` - GPS and background battery usage
- `memory` - Memory footprint and leaks
- `cpu` - CPU usage and efficiency
- `ui` - Frame rate and responsiveness
- `all` - Comprehensive performance audit

## Options

- `--fix` - Automatically apply optimizations

## Examples

```
/ruck-performance battery        # Check battery usage
/ruck-performance memory --fix   # Find and fix memory issues
/ruck-performance ui            # Profile UI performance
/ruck-performance all           # Full performance audit
```

## Performance Targets

### 🔋 Battery Usage
- **Target**: <10% per hour during active tracking
- **Idle**: <1% per hour in background
- **GPS Sampling**: Adaptive 1-5 Hz based on speed

### 💾 Memory Usage
- **Launch**: <50MB
- **Active Tracking**: <100MB
- **Background**: <20MB
- **No memory leaks

### 🖥️ CPU Usage
- **Average**: <5% during tracking
- **Peak**: <20% during calculations
- **Background**: <1%

### 📱 UI Performance
- **Frame Rate**: 60fps minimum
- **Launch Time**: <2 seconds
- **Interaction Latency**: <100ms
- **Scroll Performance**: No dropped frames

## Analysis Process

1. **Profiling** (performance-expert):
   - Instruments integration
   - Real-device testing
   - Simulated long rucks (6+ hours)
   - Various conditions (cold, heat, low battery)

2. **Issue Detection**:
   - Memory leaks and retain cycles
   - Excessive CPU wakeups
   - Inefficient GPS sampling
   - UI thread blocking
   - Unnecessary redraws

3. **Optimization**:
   - GPS adaptive sampling
   - Background task optimization
   - SwiftData query optimization
   - View update reduction
   - Image/asset optimization

4. **Validation**:
   - Before/after metrics
   - Regression testing
   - Long-term monitoring

## Output Format

```
RuckMap Performance Report
=========================
Generated by performance-expert

🔋 Battery Performance
Current: 12.3%/hour ❌
Target: <10%/hour
Issues Found:
- GPS sampling too frequent at low speeds
- Unnecessary background processing
Optimizations Applied:
- ✅ Implemented adaptive GPS sampling
- ✅ Reduced background wake frequency
New Rate: 8.7%/hour ✅

💾 Memory Profile
Peak Usage: 87MB ✅
Baseline: 45MB ✅
Leaks Detected: 0 ✅
Largest Allocations:
- MapKit cache: 32MB
- Route history: 18MB
- SwiftData cache: 12MB

🖥️ CPU Analysis
Average: 3.2% ✅
Peak: 18% ✅
Hotspots:
- Calorie calculation: 45% of CPU time
- GPS processing: 30% of CPU time
- UI updates: 25% of CPU time

📱 UI Performance
Frame Rate: 59.8 fps ✅
Launch Time: 1.8s ✅
Jank Events: 2 (during map load)
Optimization Opportunities:
- Lazy load map overlays
- Precompute route statistics

📊 Recommendations
Priority 1: Implement GPS track compression
Priority 2: Cache calorie calculations
Priority 3: Optimize SwiftData queries
```

## Automated Optimizations

When using `--fix`, the command will:

### Battery Optimizations
```swift
// Adaptive GPS sampling
locationManager.distanceFilter = speed < 2.0 ? 10.0 : 5.0
locationManager.desiredAccuracy = isStationary ? kCLLocationAccuracyNearestTenMeters : kCLLocationAccuracyBest
```

### Memory Optimizations
- Implement image caching limits
- Add SwiftData batch processing
- Configure background memory warnings

### CPU Optimizations
- Cache expensive calculations
- Debounce UI updates
- Use background queues appropriately

### UI Optimizations
- Implement view recycling
- Add progressive loading
- Optimize animation curves

## Integration with CI/CD

```yaml
# Add to GitHub Actions
- name: Performance Check
  run: |
    /ruck-performance all
    if [ $? -ne 0 ]; then
      echo "Performance regression detected"
      exit 1
    fi
```

## Related Commands

- `/ruck-test` - Run performance tests
- `/ruck-build release` - Build optimized version
- `/ruck-liquid-glass` - Check glass effect performance
- `/ruck-status` - View performance trends

This command ensures RuckMap meets all performance targets for a premium user experience.